# # Plate_NANB$order[Plate_NANB$id%in%"GG01_002637929"] <- "Scorpaeniformes"
# # Plate_NANB$family[Plate_NANB$id%in%"GG01_002637929"] <- "Scorpaenidae"
# # Plate_NANB$genus[Plate_NANB$id%in%"GG01_002637929"] <- "Sebastes"
# # Plate_NANB$species[Plate_NANB$id%in%"GG01_002637929"] <- "Sebastes spp."
# # write.csv(Plate_NANB,"Plate_NANB_collapsed_blasted_annotated_collapsed.csv",row.names = F)
# #
# # Plate_NK$class[Plate_NK$id%in%"GG01_002480775"] <- "Echinoidea"
# # write.csv(Plate_NK,"Plate_NK_collapsed_blasted_annotated_collapsed.csv",row.names = F)
# #
# # Plate_NF$species[Plate_NF$id%in%"GG01_008064849"] <- "Clupea harengus"
# # Plate_NF$[Plate_NF$id%in%"GG01_001338213"] <- "Boreogadus saida"
# # Plate_NF$genus[Plate_NF$id%in%"GG01_001338213"] <- "Boreogadus"
# # Plate_NF$species[Plate_NF$id%in%"GG01_001338213"] <- "Boreogadus saida"
# # Plate_NF$order[Plate_NF$id%in%"GG01_001338213"] <- "Perciformes"
# # Plate_NF$species[Plate_NF$id%in%"GG01_001014766"] <- "Gadus morhua"
# # Plate_NF$order[Plate_NF$id%in%"GG01_001338213"] <- "Gadiformes"
# # Plate_NF$order[Plate_NF$id%in%"GG01_005498532"] <- "Perciformes"
# # Plate_NF$order[Plate_NF$id%in%"GG01_003221632"] <- "Scorpaeniformes"
# # Plate_NF$family[Plate_NF$id%in%"GG01_003221632"] <- "Scorpaenidae"
# # Plate_NF$genus[Plate_NF$id%in%"GG01_003221632"] <- "Sebastes"
# # Plate_NF$species[Plate_NF$id%in%"GG01_003221632"] <- "Sebastes spp."
# # write.csv(Plate_NF,"Plate_NF_collapsed_blasted_annotated_collapsed.csv",row.names = F)
# #
# # Plate_NI$order[Plate_NI$id%in%"GG01_003811191"] <- "Scorpaeniformes"
# # Plate_NI$family[Plate_NI$id%in%"GG01_003811191"] <- "Scorpaenidae"
# # Plate_NI$genus[Plate_NI$id%in%"GG01_003811191"] <- "Sebastes"
# # Plate_NI$species[Plate_NI$id%in%"GG01_003811191"] <- "Sebastes spp."
# # write.csv(Plate_NI,"Plate_NI_collapsed_blasted_annotated_collapsed.csv",row.names = F)
# #
# # Plate_NE$order[Plate_NE$id%in%"GG01_000859848"] <- "Scorpaeniformes"
# # Plate_NE$family[Plate_NE$id%in%"GG01_000859848"] <- "Scorpaenidae"
# # Plate_NE$genus[Plate_NE$id%in%"GG01_000859848"] <- "Sebastes"
# # Plate_NE$species[Plate_NE$id%in%"GG01_000859848"] <- "Sebastes spp."
# # write.csv(Plate_NE,"Plate_NE_collapsed_blasted_annotated_collapsed.csv",row.names = F)
# #
# # Plate_NJ$order[Plate_NJ$id%in%"GG01_006625862"] <- "Perciformes|Scorpaeniformes"
# # Plate_NJ$genus[Plate_NJ$id%in%"GG01_000178580"] <- "Clupea"
# # Plate_NJ$species[Plate_NJ$id%in%"GG01_000178580"] <- "Clupea harengus"
# # Plate_NJ$species[Plate_NJ$id%in%"GG01_003597153"] <- "Anarhichas spp."
# # Plate_NJ$species[Plate_NJ$id%in%"GG01_004693283"] <- "Sebastes spp."
# # Plate_NJ$order[Plate_NJ$id%in%"GG01_004693283"] <- "Scorpaeniformes"
# # Plate_NJ$family[Plate_NJ$id%in%"GG01_004693283"] <- "Scorpaenidae"
# # write.csv(Plate_NJ,"Plate_NJ_collapsed_blasted_annotated_collapsed.csv",row.names = F)
# #
# # Plate_NL$order[Plate_NL$id%in%"GG01_000917475"] <- "Pleuronectidae"
# # Plate_NL$genus[Plate_NL$id%in%"GG01_000917475"] <- "Pleuronectes"
# # Plate_NL$species[Plate_NL$id%in%"GG01_000917475"] <- "Pleuronectes platessa"
# # Plate_NL$order[Plate_NL$id%in%"GG01_000917475"] <- "Pleuronectiformes"
# # Plate_NL$species[Plate_NL$id%in%"GG01_002829028"] <- "Anarhichas spp."
# # Plate_NL$order[Plate_NL$id%in%"GG01_000550564"] <- "Scorpaeniformes"
# # Plate_NL$family[Plate_NL$id%in%"GG01_000550564"] <- "Scorpaenidae"
# # Plate_NL$species[Plate_NL$id%in%"GG01_000550564"] <- "Sebastes spp."
# # write.csv(Plate_NL,"Plate_NL_collapsed_blasted_annotated_collapsed.csv",row.names = F)
# #
# # Plate_NK$genus[Plate_NK$id%in%"GG01_002960057"] <- "Clupea"
# # Plate_NK$species[Plate_NK$id%in%"GG01_002960057"] <- "Clupea harengus"
# #
# # Plate_NK$order[Plate_NK$id%in%"GG01_002376339"] <- "Scorpaeniformes"
# # Plate_NK$family[Plate_NK$id%in%"GG01_002376339"] <- "Scorpaenidae"
# # Plate_NK$genus[Plate_NK$id%in%"GG01_002376339"] <- "Sebastes"
# # Plate_NK$species[Plate_NK$id%in%"GG01_002376339"] <- "Sebastes spp."
# # write.csv(Plate_NK,"Plate_NK_collapsed_blasted_annotated_collapsed.csv",row.names = F)
#
# # Plate_NG01$species[Plate_NG01$id%in%"GG01_000372424"] <- "Glyptocephalus cynoglossus"
# # Plate_NG01$species[Plate_NG01$id%in%"GG01_000572092"] <- "Liparis fabricii|Liparis inquilinus|Liparis liparis"
# # Plate_NG01$species[Plate_NG01$id%in%"GG01_000382676"] <- "Sebastes spp."
# # Plate_NG01[Plate_NG01$id%in%"GG01_001813697",1:7] <- c("Animalia","Chordata", "Teleostei", "Scorpaeniformes","Scorpaenidae","Sebastes","Sebastes spp.")
# # write.csv(Plate_NG01,"Plate_NG01_collapsed_blasted_annotated_collapsed.csv",row.names = F)
#
# # Plate_NG02$species[Plate_NG02$id%in%"GG02_000659545"] <- "Gadus morhua"
# # Plate_NG02[Plate_NG02$id%in%"GG02_000596027",1:7] <- c("Animalia","Chordata", "Teleostei", "Scorpaeniformes","Scorpaenidae","Sebastes","Sebastes spp.")
# # write.csv(Plate_NG02,"Plate_NG02_collapsed_blasted_annotated_collapsed.csv",row.names = F)
#
# # Plate_NH01$species[Plate_NH01$id%in%"GG03_000007358"] <- "Myoxocephalus scorpius"
# # Plate_NH01[Plate_NH01$id%in%"GG03_000570544",1:7] <- c("Animalia","Chordata", "Teleostei", "Scorpaeniformes","Scorpaenidae","Sebastes","Sebastes spp.")
# # write.csv(Plate_NH01,"Plate_NH01_collapsed_blasted_annotated_collapsed.csv",row.names = F)
#
#
# # Plate_NH02$species[Plate_NH02$id%in%"GG04_000228285"] <- "Liparis fabricii|Liparis inquilinus|Liparis liparis"
# # Plate_NH02[Plate_NH02$id%in%"GG04_001201577",1:7] <- c("Animalia","Chordata", "Teleostei", "Scorpaeniformes","Scorpaenidae","Sebastes","Sebastes spp.")
# # write.csv(Plate_NH02,"Plate_NH02_collapsed_blasted_annotated_collapsed.csv",row.names = F)
#
#
#
# Plate_A_tax <- Plate_A %>%
# 	select(c("kingdom","phylum","class","order","family","genus","species"))
# Plate_A_int <- Plate_A %>%
# 	select(c("id", "annotated_pident", "best_identity"))
# Plate_A_otu <- Plate_A %>%
# 	select(-c("kingdom","phylum","class","order","family","genus","species","id", "annotated_pident", "best_identity"))
# Plate_A <- collapse(Plate_A_tax,Plate_A_int,Plate_A_otu)
#
# Plate_NF_tax <- Plate_NF %>%
# 	select(c("kingdom","phylum","class","order","family","genus","species"))
# Plate_NF_int <- Plate_NF %>%
# 	select(c("id", "annotated_pident", "best_identity"))
# Plate_NF_otu <- Plate_NF %>%
# 	select(-c("kingdom","phylum","class","order","family","genus","species","id", "annotated_pident", "best_identity"))
# Plate_NF <- collapse(Plate_NF_tax,Plate_NF_int,Plate_NF_otu)
#
# Plate_NI_tax <- Plate_NI %>%
# 	select(c("kingdom","phylum","class","order","family","genus","species"))
# Plate_NI_int <- Plate_NI %>%
# 	select(c("id", "annotated_pident", "best_identity"))
# Plate_NI_otu <- Plate_NI %>%
# 	select(-c("kingdom","phylum","class","order","family","genus","species","id", "annotated_pident", "best_identity"))
# Plate_NI <- collapse(Plate_NI_tax,Plate_NI_int,Plate_NI_otu)
#
# Plate_NJ_tax <- Plate_NJ %>%
# 	select(c("kingdom","phylum","class","order","family","genus","species"))
# Plate_NJ_int <- Plate_NJ %>%
# 	select(c("id", "annotated_pident", "best_identity"))
# Plate_NJ_otu <- Plate_NJ %>%
# 	select(-c("kingdom","phylum","class","order","family","genus","species","id", "annotated_pident", "best_identity"))
# Plate_NJ <- collapse(Plate_NJ_tax,Plate_NJ_int,Plate_NJ_otu)
#
# Plate_NK_tax <- Plate_NK %>%
# 	select(c("kingdom","phylum","class","order","family","genus","species"))
# Plate_NK_int <- Plate_NK %>%
# 	select(c("id", "annotated_pident", "best_identity"))
# Plate_NK_otu <- Plate_NK %>%
# 	select(-c("kingdom","phylum","class","order","family","genus","species","id", "annotated_pident", "best_identity"))
# Plate_NK <- collapse(Plate_NK_tax,Plate_NK_int,Plate_NK_otu)
#
# Plate_NL_tax <- Plate_NL %>%
# 	select(c("kingdom","phylum","class","order","family","genus","species"))
# Plate_NL_int <- Plate_NL %>%
# 	select(c("id", "annotated_pident", "best_identity"))
# Plate_NL_otu <- Plate_NL %>%
# 	select(-c("kingdom","phylum","class","order","family","genus","species","id", "annotated_pident", "best_identity"))
# Plate_NL <- collapse(Plate_NL_tax,Plate_NL_int,Plate_NL_otu)
#
# Plate_NG01_tax <- Plate_NG01 %>%
# 	select(c("kingdom","phylum","class","order","family","genus","species"))
# Plate_NG01_int <- Plate_NG01 %>%
# 	select(c("id", "annotated_pident", "best_identity"))
# Plate_NG01_otu <- Plate_NG01 %>%
# 	select(-c("kingdom","phylum","class","order","family","genus","species","id", "annotated_pident", "best_identity"))
# Plate_NG01 <- collapse(Plate_NG01_tax,Plate_NG01_int,Plate_NG01_otu)
#
# Plate_NG02_tax <- Plate_NG02 %>%
# 	select(c("kingdom","phylum","class","order","family","genus","species"))
# Plate_NG02_int <- Plate_NG02 %>%
# 	select(c("id", "annotated_pident", "best_identity"))
# Plate_NG02_otu <- Plate_NG02 %>%
# 	select(-c("kingdom","phylum","class","order","family","genus","species","id", "annotated_pident", "best_identity"))
# Plate_NG02 <- collapse(Plate_NG02_tax,Plate_NG02_int,Plate_NG02_otu)
#
# Plate_NH01_tax <- Plate_NH01 %>%
# 	select(c("kingdom","phylum","class","order","family","genus","species"))
# Plate_NH01_int <- Plate_NH01 %>%
# 	select(c("id", "annotated_pident", "best_identity"))
# Plate_NH01_otu <- Plate_NH01 %>%
# 	select(-c("kingdom","phylum","class","order","family","genus","species","id", "annotated_pident", "best_identity"))
# Plate_NH01 <- collapse(Plate_NH01_tax,Plate_NH01_int,Plate_NH01_otu)
#
# Plate_NH02_tax <- Plate_NH02 %>%
# 	select(c("kingdom","phylum","class","order","family","genus","species"))
# Plate_NH02_int <- Plate_NH02 %>%
# 	select(c("id", "annotated_pident", "best_identity"))
# Plate_NH02_otu <- Plate_NH02 %>%
# 	select(-c("kingdom","phylum","class","order","family","genus","species","id", "annotated_pident", "best_identity"))
# Plate_NH02 <- collapse(Plate_NH02_tax,Plate_NH02_int,Plate_NH02_otu)
#
#
#
# merging <- c("kingdom"="kingdom",
# 						 "phylum"="phylum",
# 						 "class"="class",
# 						 "order"="order",
# 						 "family"="family",
# 						 "genus"="genus",
# 						 "species"="species")
#
# x <- left_join(tax_merge,Plate_A,by=merging) %>%
# 	left_join(.,Plate_B,by=merging) %>%
# 	left_join(.,Plate_CD,by=merging) %>%
# 	left_join(.,Plate_NANB,by=merging) %>%
# 	left_join(.,Plate_NE,by=merging) %>%
# 	left_join(.,Plate_NF,by=merging) %>%
# 	left_join(.,Plate_NG01,by=merging) %>%
# 	left_join(.,Plate_NG02,by=merging) %>%
# 	left_join(.,Plate_NH01,by=merging) %>%
# 	left_join(.,Plate_NH02,by=merging) %>%
# 	left_join(.,Plate_NI,by=merging) %>%
# 	left_join(.,Plate_NJ,by=merging) %>%
# 	left_join(.,Plate_NK,by=merging) %>%
# 	left_join(.,Plate_NL,by=merging)
#
#
#
# xn <- colnames(x)
#
# xn <- xn %>% gsub("18KB70656","2018625_",.)
# xn <- xn %>% gsub("X2018625_0","X2018625_",.)
# xn <- xn %>% gsub("X19KB55241","X2019629_",.)
# xn <- xn %>% gsub("X2019629_0","X2019629_",.)
# xn <- xn %>% gsub("X2020611_0","X2020611_",.)
# xn <- xn %>% gsub("X2021607_00","X2021607_",.)
# xn <- xn %>% gsub("X2021607_0","X2021607_",.)
# xn <- gsub("(X)([1-2]\\.[LBEB]{2})", "X2018625_\\2", xn)
# xn <- gsub("(X)([1-2]EB[0-9]{3}521)","X2021607_\\2",xn)
# xn <- xn %>% gsub("\\.[xy]{1}","",.)
# xn[xn=="PCRblank_D1"] <- c("NTC_A_D1","NTC_B_D1")
# xn[xn=="PCRblank_B1"] <- c("NTC_A_B1","NTC_B_B1")
#
#
# xn <- make.unique.2(xn,sep = "-")
#
# o <- xn[grepl("-",xn)][!grepl("id|annotated_pident|best_identity|tot_reads",xn[grepl("-",xn)])]
# o <- o[!grepl("\\-1",o)]
#
# o <-
# 	o %>% gsub("\\-[0-9]","",.) %>%
# 	as.data.frame(.) %>% setNames("Filter_name") %>%
# 	left_join(.,mm,by="Filter_name") %>%
# 	select(colnames(mm))
#
# mm <- rbind(mm,o)
# mm$Filter_name <- make.unique.2(mm$Filter_name,"-")
#
# mm <- mm[mm$Filter_name%in%xn,]
#
#
# # xn[xn%in%mm$Filter_name] %>% length()
#
# colnames(x) <- xn
#
# # mm$Filter_name[mm$Filter_name%in%xn]
# # mm[mm$Filter_name%notin%xn,]
#
# x <-
# 	x %>%
# 	filter(class%in%c("Teleostei","Chondrichthyes")) %>%
# 		filter(is.na(species) | species != "Poecilia sphenops") %>%
# 		filter(is.na(species) | species != "Trigonostigma espei") %>%
# 		filter(is.na(species) | species != "Epiplatys dageti")
#
#
# tax <- x %>%
# 	select(c("kingdom","phylum","class","order","family","genus","species"))
# otu <- x %>%
# 	select(-colnames(.)[multi_grep(c("kingdom","phylum","class","order","family","genus","species","id", "annotated_pident", "best_identity","plate","tot_reads"),colnames(.))])
#
# otu[is.na(otu)] <- 0
#
# mm <- mm %>% mutate(Station_name=if_else(grepl("\\-2",Filter_name),paste0(Station_name,"_2"),Station_name))
#
# # xx <- mm %>% filter(grepl("\\-1",Filter_name))
# # xx2 <- mm %>% filter(grepl("\\-2",Filter_name))
# #
# #
# # a_l <- which(substr(xx$Filter_name,0,nchar(xx$Filter_name)-2)%in%gsub("X2019629_0","X2019629_",gsub("X19KB55241","X2019629_",colnames(Plate_A))))
# # xx[a_l,]
# # xx$Plate[a_l] <- gsub("Plate_NB \\| ","",xx$Plate[a_l])
# # xx$Plate[a_l] <- gsub("Plate_NE \\| ","",xx$Plate[a_l])
# # xx$Plate[a_l] <- gsub("Plate_NC \\| ","",xx$Plate[a_l])
# #
# # cd_l <- which(substr(xx$Filter_name,0,nchar(xx$Filter_name)-2)%in%colnames(Plate_CD))
# # xx[cd_l,]
# # xx$Plate[cd_l] <- gsub("Plate_NA \\| ","",xx$Plate[cd_l])
# # xx$Plate[cd_l] <- gsub("Plate_NF \\| ","",xx$Plate[cd_l])
# #
# # nanb_l <- which(substr(xx$Filter_name,0,nchar(xx$Filter_name)-2)%in%colnames(Plate_NANB))
# # xx[nanb_l,]
# # xx$Plate[nanb_l] <- gsub("Plate_NA \\| ","",xx$Plate[nanb_l])
# #
# # a2_l <- which(substr(xx$Filter_name,0,nchar(xx$Filter_name)-2)%in%gsub("X2018625_0","X2018625_",gsub("18KB70656","2018625_",colnames(Plate_A))))
# # xx[a2_l,]
# # xx$Plate[a2_l] <- gsub("Plate_NF \\| ","",xx$Plate[a2_l])
# # xx$Plate[a2_l] <- gsub("Plate_NE \\| ","",xx$Plate[a2_l])
# # xx$Plate[a2_l] <- gsub("Plate_ND \\| ","",xx$Plate[a2_l])
# #
# #
# # ne_l <- which(substr(xx$Filter_name,0,nchar(xx$Filter_name)-2)%in%colnames(Plate_NE))
# # xx[ne_l,]
# # xx$Plate[ne_l] <- gsub("Plate_NE \\| ","",xx$Plate[ne_l])
# #
# # nf_l <- which(substr(xx$Filter_name,0,nchar(xx$Filter_name)-2)%in%colnames(Plate_NF))
# # xx[nf_l,]
# # xx$Plate[nf_l] <- gsub("Plate_NF \\| ","",xx$Plate[nf_l])
# #
# # a_l <- which(substr(xx2$Filter_name,0,nchar(xx2$Filter_name)-2)%in%gsub("X2019629_0","X2019629_",gsub("X19KB55241","X2019629_",colnames(Plate_A))))
# # xx2[a_l,]
# # xx2$Plate[a_l] <- gsub(" \\| Plate_A","",xx2$Plate[a_l])
# # xx2$Plate[a_l] <- gsub("Plate_NC \\| ","",xx2$Plate[a_l])
# #
# # cd_l <- which(substr(xx2$Filter_name,0,nchar(xx2$Filter_name)-2)%in%colnames(Plate_CD))
# # xx2[cd_l,]
# # xx2$Plate[cd_l] <- gsub(" \\| Plate_D","",xx2$Plate[cd_l])
# # xx2$Plate[cd_l] <- gsub(" \\| Plate_C","",xx2$Plate[cd_l])
# #
# # nanb_l <- which(substr(xx2$Filter_name,0,nchar(xx2$Filter_name)-2)%in%colnames(Plate_NANB))
# # xx2[nanb_l,]
# # xx2$Plate[nanb_l] <- gsub(" \\| Plate_D","",xx2$Plate[nanb_l])
# # xx2$Plate[nanb_l] <- gsub(" \\| Plate_C","",xx2$Plate[nanb_l])
# #
# # a2_l <- which(substr(xx2$Filter_name,0,nchar(xx2$Filter_name)-2)%in%gsub("X2018625_0","X2018625_",gsub("18KB70656","2018625_",colnames(Plate_A))))
# # xx2[a2_l,]
# # xx2$Plate[a2_l] <- gsub(" \\| Plate_A","",xx2$Plate[a2_l])
# # xx2$Plate[a2_l] <- gsub("Plate_ND \\| ","",xx2$Plate[a2_l])
# #
# #
# # ne_l <- which(substr(xx2$Filter_name,0,nchar(xx2$Filter_name)-2)%in%colnames(Plate_NE))
# # xx2[ne_l,]
# # xx2$Plate[ne_l] <- gsub(" \\| Plate_A","",xx2$Plate[ne_l])
# #
# # nf_l <- which(substr(xx2$Filter_name,0,nchar(xx2$Filter_name)-2)%in%colnames(Plate_NF))
# # xx2[nf_l,]
# # xx2$Plate[nf_l] <- gsub(" \\| Plate_A","",xx2$Plate[nf_l])
# # xx2$Plate[nf_l] <- gsub(" \\| Plate_C","",xx2$Plate[nf_l])
# #
# # xx %>% distinct(Plate)
# # xx2 %>% distinct(Plate)
# #
# # mm[grepl("\\-1",mm$Filter_name),] <- xx
# # mm[grepl("\\-2",mm$Filter_name),] <- xx2
# #
# #
# #
# # xx <- mm %>% filter(grepl(" \\| ",Plate))
# # xx$Plate <- gsub("Plate_NC \\| ","",xx$Plate)
# # xx$Plate <- gsub("Plate_ND \\| ","",xx$Plate)
# # xx$Plate <- gsub(" \\| Plate_E","",xx$Plate)
# # xx$Plate[xx$Filter_name%in%c("X2018625_6","X2018625_30")] <- gsub("Plate_NE \\| ","",xx$Plate[xx$Filter_name%in%c("X2018625_6","X2018625_30")])
# #
# # mm[grepl(" \\| ",mm$Plate),] <- xx
# # xx <- mm %>% filter()
# #
# # write.csv(mm,"metadata_curated.csv",row.names = F)
#
# mm <- read.csv("/Users/a36142/Library/CloudStorage/OneDrive-Havforskningsinstituttet/IMR/Data/eDNA/Paper_III/Metadata_curated.csv")
# mm <-
# 	mm %>%
# 	mutate(Season=substr(start = 4,stop = 5,Date)) %>%
# 	mutate(Season=if_else(Season=="03","Spring",Season)) %>%
# 	mutate(Season=if_else(Season=="05","Summer",Season)) %>%
# 	mutate(Season=if_else(Season=="06","Summer",Season)) %>%
# 	mutate(Season=if_else(Season=="09","Autumn",Season)) %>%
# 	mutate(Season=if_else(Season=="10","Autumn",Season)) %>%
# 	mutate(Season = factor(Season, levels = c("Spring", "Summer", "Autumn"))) %>%
# 	mutate(Location=substr(start = 0,stop = 2,Station_name)) %>%
# 	mutate(Location=if_else(grepl("\\-2",Filter_name),paste0(Location,"_2"),Location)) %>%
# 	mutate(Location = factor(Location, levels = c("BA", "FR", "OL","BE","BA_2","FR_2"))) %>%
# 	mutate(Month=substr(start = 4,stop = 5,Date)) %>%
# 	mutate(Year=substr(start = 7,stop = 10,Date)) %>%
# 	mutate(Date_2=paste0(Year,"_",Month))
# Import data -----------------------------------------------------------------------
otu <- read.csv(here('6_OTU_TAX_META','otu.csv'),check.names = FALSE)
tax <- read.csv(here('6_OTU_TAX_META','tax.csv'))
mm <- read.csv(here('6_OTU_TAX_META','Metadata_curated.csv'))
# Prepare the data ------------------------------------------------------------------
otu_coll <- collapse_otu(otu %>% select(mm$Filter_name),
mm %>% mutate(collapse.name=paste0(Cruise,"_",Station_name,"_",Sample_type)))
mm_coll <- collapse_meta(mm %>% mutate(collapse.name=paste0(Cruise,"_",Station_name,"_",Sample_type)))
#Filter the duplicated stations (BA_2 and FR_2)
mm_coll <- mm_coll %>%
filter(!(Location=="BA"&Cruise_no==2019629)) %>%
filter(!(Location=="BA"&Cruise_no==2018625)) %>%
filter(!(Location=="FR"&Cruise_no==2021607))
otu_coll <- otu_coll %>% select(mm_coll$collapse.name)
mm_coll <- mm_coll %>%
mutate(Location=if_else(grepl("_2",Location),substr(Location,0,2),Location))
# Alpha diversity analysis ----------------------------------------------------------
alpha <- pa_conversion(otu_coll) %>% colSums() %>% as.data.frame() %>%
rownames_to_column("Sample") %>% setNames(c("Sample","Richness"))
alpha <- mm_coll %>% mutate(Rich=merr2(collapse.name,alpha$Sample,alpha$Richness)) %>%
mutate(Rich = as.numeric(Rich))
# Filter the blanks
alpha <- alpha %>% filter(sample_type=="e_sample")
alpha_summary <-
alpha %>%
group_by(Location,Season, Year) %>%
summarise(richness_mean = mean(Rich, na.rm = TRUE),
q_25=quantile(Rich,0.25),
q_75=quantile(Rich,0.75), .groups = 'drop')
# Figure 2 - Alpha metrics ----------------------------------------------------------
cc <- c("BA" = "deepskyblue2",
"FR" = "orange2",
"OL" = "tomato2",
"BE" = "green3")
p1 <-
ggplot() +
geom_jitter(data = alpha %>% filter(Season=="Autumn"),
aes(x = as.character(Year), y = Rich, color=Location), position=position_dodge(width=0.4),alpha=0.5) +
theme_classic() +
geom_errorbar(data = alpha_summary %>% 	filter(Season=="Autumn"),
aes(x = as.character(Year), ymin = q_25, ymax = q_75,color=Location),width = 0.3,
position = position_dodge(width = 0.4))+
geom_point(data = alpha_summary %>% 	filter(Season=="Autumn"),
aes(x = as.character(Year), y = richness_mean, color=Location),
position = position_dodge(width = 0.4), size = 6) + # Nudge points to the right
ylim(3, 43)+
ylab("Species richness")+
xlab("")+
scale_color_manual(values=cc)+
facet_wrap(~Season)+
theme(legend.position = "none",
axis.title.y = element_text(size = 19),
plot.margin = margin(0.1, 0, 0.5, 0.5, "cm"),
axis.title.x = element_text(size = 19),
legend.title = element_text(size=17),
legend.key.height = unit(1.0, 'cm'),
legend.text = element_text(size=16),
axis.text.x = element_text(size = 17),
strip.text = element_text(size = 17, color="white"),
strip.background = element_rect(fill = "deepskyblue4", color = "black", size = 0.5, linetype = "dotted"),
axis.text.y=element_text(size=15))
p2 <-
ggplot() +
geom_jitter(data = alpha %>% filter(Season=="Spring"),
aes(x = as.character(Year), y = Rich, color=Location), position=position_dodge(width=0.4),alpha=0.5) +
theme_classic() +
geom_errorbar(data = alpha_summary %>% 	filter(Season=="Spring"),
aes(x = as.character(Year), ymin = q_25, ymax = q_75,color=Location),width = 0.3,
position = position_dodge(width = 0.4))+
geom_point(data = alpha_summary %>% 	filter(Season=="Spring"),
aes(x = as.character(Year), y = richness_mean, color=Location),
position = position_dodge(width = 0.4), size = 6) + # Nudge points to the right
ylim(3, 43)+
ylab("Species richness")+
xlab("")+
scale_color_manual(values=cc)+
facet_wrap(~Season)+
theme(legend.position = "none",
axis.title.y = element_blank(),
plot.margin = margin(0.1, 0.0, 0.5, 0.5, "cm"),
axis.title.x = element_text(size = 19),
legend.title = element_text(size=17),
legend.key.height = unit(1.0, 'cm'),
legend.text = element_text(size=16),
axis.text.x = element_text(size = 17),
axis.text.y = element_blank(),
axis.line.y = element_blank(),
strip.background = element_rect(fill = "orange2", color = "black", size = 0.5, linetype = "dotted"),
strip.text = element_text(size = 17),
axis.ticks.y = element_blank())
p3 <-
ggplot() +
geom_jitter(data = alpha %>% filter(Season=="Summer"),
aes(x = as.character(Year), y = Rich, color=Location), position=position_dodge(width=0.4),alpha=0.5) +
theme_classic() +
geom_errorbar(data = alpha_summary %>% filter(Season=="Summer"),
aes(x = as.character(Year), ymin = q_25, ymax = q_75,color=Location),width = 0.3,
position = position_dodge(width = 0.4))+
geom_point(data = alpha_summary %>% filter(Season=="Summer"),
aes(x = as.character(Year), y = richness_mean, color=Location),
position = position_dodge(width = 0.4), size = 6) + # Nudge points to the right
ylim(3, 43)+
ylab("Species richness")+
xlab("")+
scale_color_manual(values=cc)+
facet_wrap(~Season)+
theme(legend.position = "none",
axis.title.y = element_blank(),
plot.margin = margin(0.1, -0.5, 0.5, 0.5, "cm"),
axis.title.x = element_text(size = 19),
legend.title = element_text(size=17),
legend.key.height = unit(1.0, 'cm'),
legend.text = element_text(size=16),
axis.text.x = element_text(size = 17),
axis.text.y = element_blank(),
axis.line.y = element_blank(),
strip.text = element_text(size = 17),
strip.background = element_rect(fill = "lightblue", color = "black", size = 0.5, linetype = "dotted"),
axis.ticks.y = element_blank())
pp1 <- cowplot::plot_grid(p1,p2,p3,align = "h",rel_widths = c(5,2,3),ncol = 3)
cc1 <- c("Balfsfjord" = "deepskyblue2",
"Frakkfjord" = "orange2",
"Olderfjord" = "tomato2",
"Bergsfjord" = "green3")
p1_leg <-
ggplot() +
theme_classic() +
geom_errorbar(data = alpha_summary %>%
mutate(Location=if_else(Location=="BA","Balfsfjord",Location)) %>%
mutate(Location=if_else(Location=="FR","Frakkfjord",Location)) %>%
mutate(Location=if_else(Location=="OL","Olderfjord",Location)) %>%
mutate(Location=if_else(Location=="BE","Bergsfjord",Location)), aes(x = as.character(Year), ymin = q_25, ymax = q_75,color=Location))+
geom_point(data = alpha_summary %>%
mutate(Location=if_else(Location=="BA","Balfsfjord",Location)) %>%
mutate(Location=if_else(Location=="FR","Frakkfjord",Location)) %>%
mutate(Location=if_else(Location=="OL","Olderfjord",Location)) %>%
mutate(Location=if_else(Location=="BE","Bergsfjord",Location)),
aes(x = as.character(Year), y = richness_mean, color=Location),size = 6) + # Nudge points to the right
scale_color_manual("Location",values=cc1)+
theme(plot.margin = margin(1, 1, 1, 0, "cm"),
legend.key.width = unit(1.2,"cm"),
legend.title = element_text(size=18),
legend.key.height = unit(0.8, 'cm'),
legend.text = element_text(size=16))
p1_leg_leg <- cowplot::get_legend(p1_leg+
theme(legend.justification = c(0.5,0.5)))
pp2 <- cowplot::plot_grid(pp1,p1_leg_leg,rel_widths = c(8,1.4),ncol = 2)
# ggsave(paste0("/Users/a36142/Library/CloudStorage/OneDrive-Havforskningsinstituttet/IMR/Data/eDNA/Paper_III/Plots",
# 							"/Figure_2_Alpha diversity.jpg"),pp2,width=35,height=25,units="cm")
model <- glmer(Rich ~ Season*Location + (1|Year), data = alpha, family = poisson())
# model <- glmer(Rich ~ Season + (1 | Location), data = alpha, family = poisson())
# model <- glmer(Rich ~ (Year*Season) + (1 | Location), data = alpha, family = poisson())
summary(model)
alpha %>% group_by(Location) %>% summarise(Rich)
alpha %>% group_by(Location) %>% summarise(mean_rich=mean(Rich))
alpha %>% group_by(Season) %>% summarise(mean_rich=mean(Rich))
alpha %>% group_by(Season) %>% summarise(mean_rich=mean(Rich),se=sd(Rich))
alpha %>% group_by(Location) %>% summarise(mean_rich=mean(Rich),se=sd(Rich))
alpha %>% group_by(Season,Location) %>% summarise(mean_rich=mean(Rich),se=sd(Rich))
alpha %>% group_by(Season,Location) %>% summarise(mean_rich=mean(Rich),se=sd(Rich)) %>% arrange(Location)
alpha %>% group_by(Season) %>% summarise(mean_rich=mean(Rich),se=sd(Rich))
alpha %>% group_by(Location) %>% summarise(mean_rich=mean(Rich),se=sd(Rich))
alpha %>% group_by(Season,Location) %>% summarise(mean_rich=mean(Rich),se=sd(Rich)) %>% arrange(Location)
alpha %>% group_by(Season) %>% summarise(mean_rich=mean(Rich),se=sd(Rich))
alpha %>% group_by(Location) %>% summarise(mean_rich=mean(Rich),se=sd(Rich))
